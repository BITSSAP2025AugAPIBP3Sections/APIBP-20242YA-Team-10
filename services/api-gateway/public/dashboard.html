<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Streamify</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar-brand">üé¨ Streamify</div>
            <div class="navbar-menu">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="videos.html" class="nav-link">Videos</a>
                <a href="streaming.html" class="nav-link">Streaming</a>
                <a href="billing.html" class="nav-link">Billing</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
            </div>
            <div id="navUserInfo"></div>
        </nav>

        <div id="message"></div>

        <!-- Welcome Section -->
        <div class="card">
            <div class="card-header">
                <h2>Welcome to Streamify Dashboard</h2>
            </div>
            <div class="card-body">
                <p>Streamify is a complete video streaming platform built on microservices architecture. Access all services through the navigation menu above.</p>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-header">
                <h2>Quick Overview</h2>
            </div>
            <div class="grid grid-4" id="quickStats">
                <div class="stat-card">
                    <h3 id="totalVideos">-</h3>
                    <p>Total Videos</p>
                </div>
                <div class="stat-card">
                    <h3 id="userBalance">-</h3>
                    <p>Your Balance</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalWatched">-</h3>
                    <p>Videos Watched</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalSpent">-</h3>
                    <p>Total Spent</p>
                </div>
            </div>
        </div>

        <!-- Services Overview -->
        <div class="card">
            <div class="card-header">
                <h2>üéØ Available Services</h2>
            </div>
            <div class="grid grid-2">
                <div class="video-card">
                    <h3>üë§ Auth Service</h3>
                    <p>Manage your account, profile, and authentication.</p>
                    <div class="btn-group mt-2">
                        <a href="profile.html" class="btn btn-primary">View Profile</a>
                    </div>
                </div>
                
                <div class="video-card">
                    <h3>üé• Video Service</h3>
                    <p>Browse, upload, and manage videos in the platform.</p>
                    <div class="btn-group mt-2">
                        <a href="videos.html" class="btn btn-primary">Browse Videos</a>
                    </div>
                </div>
                
                <div class="video-card">
                    <h3>‚ñ∂Ô∏è Streaming Service</h3>
                    <p>Watch videos with pay-per-minute streaming.</p>
                    <div class="btn-group mt-2">
                        <a href="streaming.html" class="btn btn-primary">Active Sessions</a>
                    </div>
                </div>
                
                <div class="video-card">
                    <h3>üí≥ Billing Service</h3>
                    <p>Manage your balance, deposits, and payment history.</p>
                    <div class="btn-group mt-2">
                        <a href="billing.html" class="btn btn-primary">Manage Billing</a>
                    </div>
                </div>
                
                <div class="video-card">
                    <h3>üìä Analytics Service</h3>
                    <p>View platform statistics and your activity reports.</p>
                    <div class="btn-group mt-2">
                        <a href="analytics.html" class="btn btn-primary">View Analytics</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div class="card-header">
                <h2>Recent Activity</h2>
            </div>
            <div id="recentActivity">
                <p>Loading recent activity...</p>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script>
        // Initialize page
        initPage('dashboard.html', true);

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load videos count
                const videosResult = await apiRequest('/api/videos', {
                    method: 'GET',
                    requireAuth: false
                });
                
                if (videosResult.success) {
                    document.getElementById('totalVideos').textContent = videosResult.data.length;
                }

                // Load user balance
                const balanceResult = await apiRequest('/api/billing/balance', {
                    method: 'GET'
                });
                
                if (balanceResult.success) {
                    document.getElementById('userBalance').textContent = formatCurrency(balanceResult.data.balance);
                }

                // Load user activity
                const activityResult = await apiRequest('/api/analytics/user', {
                    method: 'GET'
                });
                
                if (activityResult.success) {
                    const activity = activityResult.data;
                    document.getElementById('totalWatched').textContent = activity.history.length;
                    document.getElementById('totalSpent').textContent = formatCurrency(activity.totalSpent);
                    
                    // Display recent activity
                    displayRecentActivity(activity.history);
                } else {
                    document.getElementById('totalWatched').textContent = '0';
                    document.getElementById('totalSpent').textContent = '$0.00';
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                showMessage('Error loading dashboard data', 'error');
            }
        }

        // Display recent activity
        function displayRecentActivity(history) {
            const container = document.getElementById('recentActivity');
            
            if (!history || history.length === 0) {
                container.innerHTML = '<p>No recent activity found. Start watching videos!</p>';
                return;
            }

            const recentSessions = history.slice(-5).reverse();
            
            container.innerHTML = `
                <div class="grid grid-2">
                    ${recentSessions.map(session => `
                        <div class="video-card">
                            <p><strong>Session:</strong> ${session.sessionId}</p>
                            <p><strong>Video ID:</strong> ${session.videoId}</p>
                            <p><strong>Watch Time:</strong> ${formatDuration(session.watchedTime)}</p>
                            <p><strong>Started:</strong> ${formatDate(session.startTime)}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
