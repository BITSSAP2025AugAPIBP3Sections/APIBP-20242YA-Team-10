<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming - Streamify</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar-brand">üé¨ Streamify</div>
            <div class="navbar-menu">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="videos.html" class="nav-link">Videos</a>
                <a href="streaming.html" class="nav-link active">Streaming</a>
                <a href="billing.html" class="nav-link">Billing</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
            </div>
            <div id="navUserInfo"></div>
        </nav>

        <div id="message"></div>

        <!-- Streaming Service -->
        <div class="card">
            <div class="card-header">
                <h2>‚ñ∂Ô∏è Streaming Service</h2>
            </div>
            <div class="card-body">
                <p>Pay-per-minute video streaming service. Start watching videos and your balance will be deducted in real-time.</p>
            </div>
        </div>

        <!-- Video Player Section -->
        <div id="playerSection" class="card hidden">
            <div class="card-header">
                <h2 id="videoTitle">Now Playing</h2>
            </div>
            <div class="card-body">
                <div id="videoInfo" class="mb-3"></div>

                <!-- Video Player -->
                <div style="background: #000; border-radius: 10px; padding: 20px; text-align: center; position: relative;">
                    <video
                        id="videoPlayer"
                        width="100%"
                        height="400"
                        controls
                        style="border-radius: 8px; max-width: 100%;"
                        poster=""
                        preload="metadata"
                    >
                        <source id="videoSource" src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>

                    <!-- Video Info Overlay -->
                    <div style="color: white; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div>
                            <p id="streamingStatus" style="margin: 5px 0; font-weight: bold;">Ready to play</p>
                        </div>
                        <div style="text-align: right;">
                            <p id="watchTime" style="font-size: 1.5rem; margin: 5px 0;">00:00</p>
                            <p id="costInfo" style="margin: 5px 0;">Cost: $0.00</p>
                        </div>
                    </div>
                </div>

                <div class="btn-group mt-3">
                    <button id="playPauseBtn" onclick="togglePlayPause()" class="btn btn-success">‚ñ∂Ô∏è Play</button>
                    <button onclick="stopStream()" class="btn btn-danger">‚èπÔ∏è Stop Stream</button>
                    <button onclick="restartVideo()" class="btn btn-secondary">üîÑ Restart</button>
                </div>

                <div class="mt-3">
                    <p><strong>Session ID:</strong> <span id="sessionId">-</span></p>
                    <p><strong>Current Balance:</strong> <span id="currentBalance">-</span></p>
                </div>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="card">
            <div class="card-header">
                <h2>Active Sessions</h2>
            </div>
            <div id="sessionsContainer">
                <p>No active streaming sessions</p>
            </div>
        </div>

        <!-- Browse Videos -->
        <div class="card">
            <div class="card-header">
                <h2>Browse Videos to Stream</h2>
            </div>
            <div id="browseVideos">
                <p>Loading available videos...</p>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script>
        // Initialize page
        initPage('streaming.html', true);

        let currentSession = null;
        let heartbeatInterval = null;
        let isPlaying = false;
        let elapsedSeconds = 0;

        // Get video ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoIdParam = urlParams.get('videoId');

        // Check if there's a video to stream
        if (videoIdParam) {
            startNewStream(videoIdParam);
        }

        // Start new stream
        async function startNewStream(videoId) {
            showMessage('Starting stream...', 'info');

            const result = await apiRequest(`/api/stream/start/${videoId}`, {
                method: 'POST'
            });

            if (result.success) {
                currentSession = result.data;
                displayVideoPlayer(result.data);
                showMessage('Stream started successfully!', 'success');
            } else {
                showMessage(result.error || 'Failed to start stream. Please check your balance.', 'error');
                if (result.error && result.error.includes('Insufficient funds')) {
                    setTimeout(() => {
                        if (confirm('Insufficient funds. Would you like to add funds now?')) {
                            window.location.href = 'billing.html';
                        }
                    }, 1500);
                }
            }
        }

        // Display video player
        function displayVideoPlayer(sessionData) {
            const playerSection = document.getElementById('playerSection');
            playerSection.classList.remove('hidden');

            document.getElementById('videoTitle').textContent = sessionData.videoDetails.title;
            document.getElementById('sessionId').textContent = sessionData.sessionId;

            // Set up video player
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');

            // Set video source to the streaming URL
            videoSource.src = `/api/stream/url/${sessionData.sessionId}`;
            videoPlayer.load(); // Reload the video element with new source

            // Add event listeners to the video player
            videoPlayer.addEventListener('loadstart', () => {
                document.getElementById('streamingStatus').textContent = 'Loading video...';
            });

            videoPlayer.addEventListener('canplay', () => {
                document.getElementById('streamingStatus').textContent = 'Ready to play';
                showMessage('Video loaded successfully!', 'success');
            });

            videoPlayer.addEventListener('play', () => {
                playStream();
            });

            videoPlayer.addEventListener('pause', () => {
                pauseStream();
            });

            videoPlayer.addEventListener('ended', () => {
                showMessage('Video ended', 'info');
                pauseStream();
            });

            videoPlayer.addEventListener('timeupdate', () => {
                elapsedSeconds = Math.floor(videoPlayer.currentTime);
                updateTimer();
            });

            videoPlayer.addEventListener('error', (e) => {
                console.error('Video error:', e);
                document.getElementById('streamingStatus').textContent = 'Video error';
                showMessage('Video playback error. Please try refreshing the page.', 'error');
            });

            videoPlayer.addEventListener('waiting', () => {
                document.getElementById('streamingStatus').textContent = 'Buffering...';
            });

            videoPlayer.addEventListener('playing', () => {
                document.getElementById('streamingStatus').textContent = 'Playing...';
            });

            const videoInfo = document.getElementById('videoInfo');
            videoInfo.innerHTML = `
                <p><strong>Description:</strong> ${sessionData.videoDetails.description || 'N/A'}</p>
                <p><strong>Duration:</strong> ${formatDuration(sessionData.videoDetails.duration)}</p>
                <p><strong>Price:</strong> ${sessionData.videoDetails.pricePerMinute}¬¢/minute</p>
            `;

            updateBalance();
            scrollToPlayer();
        }

        // Scroll to player
        function scrollToPlayer() {
            document.getElementById('playerSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Toggle play/pause
        function togglePlayPause() {
            if (!currentSession) return;

            const videoPlayer = document.getElementById('videoPlayer');

            if (videoPlayer.paused) {
                videoPlayer.play();
            } else {
                videoPlayer.pause();
            }
        }

        // Play stream
        function playStream() {
            if (!currentSession) return;

            isPlaying = true;
            document.getElementById('playPauseBtn').innerHTML = '‚è∏Ô∏è Pause';
            document.getElementById('streamingStatus').textContent = 'Playing...';

            // Start heartbeat (every 30 seconds)
            if (!heartbeatInterval) {
                heartbeatInterval = setInterval(() => {
                    sendHeartbeat();
                }, 30000);
            }
        }

        // Pause stream
        function pauseStream() {
            isPlaying = false;
            document.getElementById('playPauseBtn').innerHTML = '‚ñ∂Ô∏è Play';
            document.getElementById('streamingStatus').textContent = 'Paused';

            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // Send heartbeat
        async function sendHeartbeat() {
            if (!currentSession) return;

            const result = await apiRequest(`/api/stream/heartbeat/${currentSession.sessionId}`, {
                method: 'PUT'
            });

            if (result.success) {
                console.log('Heartbeat sent:', result.data);
                updateBalance();
            } else {
                showMessage('Heartbeat failed. Stream may be interrupted.', 'warning');
                pauseStream();
            }
        }

        // Update timer
        function updateTimer() {
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('watchTime').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Update cost
            if (currentSession) {
                const watchedMinutes = Math.ceil(elapsedSeconds / 60);
                const cost = currentSession.videoDetails.pricePerMinute * watchedMinutes;
                document.getElementById('costInfo').textContent = `Cost: ${formatCurrency(cost)}`;
            }
        }

        // Update balance
        async function updateBalance() {
            const result = await apiRequest('/api/billing/balance', {
                method: 'GET'
            });

            if (result.success) {
                document.getElementById('currentBalance').textContent = formatCurrency(result.data.balance);
            }
        }

        // Stop stream
        function stopStream() {
            if (!currentSession) return;

            if (confirm('Are you sure you want to stop the stream?')) {
                const videoPlayer = document.getElementById('videoPlayer');
                videoPlayer.pause();
                videoPlayer.currentTime = 0;

                pauseStream();
                currentSession = null;
                document.getElementById('playerSection').classList.add('hidden');
                showMessage('Stream stopped', 'info');
                elapsedSeconds = 0;

                // Reload page to clear URL params
                window.location.href = 'streaming.html';
            }
        }

        // Restart video
        function restartVideo() {
            if (!currentSession) return;

            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.currentTime = 0;
            elapsedSeconds = 0;
            updateTimer();
            showMessage('Video restarted', 'info');
        }

        // Load browse videos
        async function loadBrowseVideos() {
            const result = await apiRequest('/api/videos', {
                method: 'GET',
                requireAuth: false
            });

            if (result.success) {
                displayBrowseVideos(result.data);
            }
        }

        // Display browse videos
        function displayBrowseVideos(videos) {
            const container = document.getElementById('browseVideos');

            if (videos.length === 0) {
                container.innerHTML = '<p>No videos available</p>';
                return;
            }

            container.innerHTML = `
                <div class="grid grid-3">
                    ${videos.map(video => `
                        <div class="video-card">
                            <h3>${video.title}</h3>
                            <p><strong>Duration:</strong> ${formatDuration(video.duration)}</p>
                            <p><strong>Price:</strong> ${video.pricePerMinute}¬¢/min</p>
                            <p><strong>Category:</strong> <span class="badge badge-primary">${video.category}</span></p>
                            <button onclick="startNewStream('${video._id}')" class="btn btn-success mt-2">‚ñ∂Ô∏è Stream Now</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Load browse videos on page load
        loadBrowseVideos();
    </script>
</body>
</html>
