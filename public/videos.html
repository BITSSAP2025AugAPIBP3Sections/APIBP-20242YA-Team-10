<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videos - Streamify</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="navbar-brand">ðŸŽ¬ Streamify</div>
            <div class="navbar-menu">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="videos.html" class="nav-link active">Videos</a>
                <a href="streaming.html" class="nav-link">Streaming</a>
                <a href="billing.html" class="nav-link">Billing</a>
                <a href="analytics.html" class="nav-link">Analytics</a>
            </div>
            <div id="navUserInfo"></div>
        </nav>

        <div id="message"></div>

        <!-- Video Service -->
        <div class="card">
            <div class="card-header">
                <h2>ðŸŽ¥ Video Service</h2>
            </div>
            <div class="card-body">
                <div class="btn-group">
                    <button onclick="loadVideos()" class="btn btn-primary">Refresh Videos</button>
                    <button onclick="showUploadModal()" class="btn btn-success">Upload Video</button>
                </div>

                <!-- Search and Filters -->
                <div class="mt-3">
                    <div class="form-group">
                        <input type="text" id="searchQuery" placeholder="Search videos..." onkeyup="handleSearch()">
                    </div>
                    <div class="form-group">
                        <select id="categoryFilter" onchange="loadVideos()">
                            <option value="">All Categories</option>
                            <option value="general">General</option>
                            <option value="education">Education</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="technology">Technology</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Videos Grid -->
        <div class="card">
            <div class="card-header">
                <h2>Available Videos</h2>
            </div>
            <div id="videosContainer">
                <p>Loading videos...</p>
            </div>
        </div>

        <!-- Upload Modal -->
        <div id="uploadModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Upload New Video</h2>
                    <button class="modal-close" onclick="closeUploadModal()">&times;</button>
                </div>
                <form onsubmit="handleUpload(event)">
                    <div class="form-group">
                        <label for="videoTitle">Title *</label>
                        <input type="text" id="videoTitle" required placeholder="Enter video title">
                    </div>
                    <div class="form-group">
                        <label for="videoDescription">Description</label>
                        <textarea id="videoDescription" placeholder="Enter video description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="videoCategory">Category *</label>
                        <select id="videoCategory" required>
                            <option value="general">General</option>
                            <option value="education">Education</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="technology">Technology</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pricePerMinute">Price per Minute (cents) *</label>
                        <input type="number" id="pricePerMinute" required min="1" value="10" placeholder="e.g., 10 cents">
                    </div>
                    <div class="form-group">
                        <label for="videoFile">Video File *</label>
                        <input type="file" id="videoFile" required accept="video/*">
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Upload</button>
                        <button type="button" onclick="closeUploadModal()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Video</h2>
                    <button class="modal-close" onclick="closeEditModal()">&times;</button>
                </div>
                <form onsubmit="handleEdit(event)">
                    <input type="hidden" id="editVideoId">
                    <div class="form-group">
                        <label for="editVideoTitle">Title *</label>
                        <input type="text" id="editVideoTitle" required placeholder="Enter video title">
                    </div>
                    <div class="form-group">
                        <label for="editVideoDescription">Description</label>
                        <textarea id="editVideoDescription" placeholder="Enter video description"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="utils.js"></script>
    <script>
        // Initialize page
        initPage('videos.html', true);

        let currentVideos = [];

        // Load videos
        async function loadVideos() {
            showLoading('videosContainer');
            
            const category = document.getElementById('categoryFilter').value;
            const searchQuery = document.getElementById('searchQuery').value;
            
            let endpoint = '/api/videos?';
            if (category) endpoint += `category=${category}&`;
            if (searchQuery) endpoint += `search=${searchQuery}&`;
            
            const result = await apiRequest(endpoint, {
                method: 'GET',
                requireAuth: false
            });
            
            if (result.success) {
                currentVideos = result.data;
                displayVideos(result.data);
            } else {
                document.getElementById('videosContainer').innerHTML = 
                    `<p class="error">Error loading videos: ${result.error}</p>`;
            }
        }

        // Display videos
        function displayVideos(videos) {
            const container = document.getElementById('videosContainer');
            
            if (videos.length === 0) {
                container.innerHTML = '<p>No videos found. Upload some videos to get started!</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="grid grid-3">
                    ${videos.map(video => `
                        <div class="video-card">
                            <h3>${video.title}</h3>
                            <p><strong>Description:</strong> ${video.description || 'No description'}</p>
                            <p><strong>Category:</strong> <span class="badge badge-primary">${video.category}</span></p>
                            <p><strong>Duration:</strong> ${formatDuration(video.duration)}</p>
                            <p><strong>Price:</strong> ${video.pricePerMinute}Â¢/min</p>
                            <div class="btn-group mt-2">
                                <button onclick="startStreaming('${video._id}')" class="btn btn-success">Watch</button>
                                <button onclick="showEditModal('${video._id}')" class="btn btn-secondary">Edit</button>
                                <button onclick="deleteVideo('${video._id}')" class="btn btn-danger">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Search handler with debounce
        const handleSearch = debounce(() => {
            loadVideos();
        }, 500);

        // Show upload modal
        function showUploadModal() {
            if (!isAuthenticated()) {
                showMessage('Please login to upload videos', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }
            document.getElementById('uploadModal').classList.add('active');
        }

        // Close upload modal
        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDescription').value = '';
            document.getElementById('videoFile').value = '';
        }

        // Handle upload
        async function handleUpload(event) {
            event.preventDefault();
            
            const formData = new FormData();
            formData.append('title', document.getElementById('videoTitle').value);
            formData.append('description', document.getElementById('videoDescription').value);
            formData.append('category', document.getElementById('videoCategory').value);
            formData.append('pricePerMinute', document.getElementById('pricePerMinute').value);
            formData.append('videoFile', document.getElementById('videoFile').files[0]);
            
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/api/videos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('Video uploaded successfully!', 'success');
                    closeUploadModal();
                    loadVideos();
                } else {
                    showMessage(result.error || 'Upload failed', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Network error occurred', 'error');
            }
        }

        // Show edit modal
        function showEditModal(videoId) {
            if (!isAuthenticated()) {
                showMessage('Please login to edit videos', 'error');
                return;
            }
            
            const video = currentVideos.find(v => v._id === videoId);
            if (!video) return;
            
            document.getElementById('editVideoId').value = video._id;
            document.getElementById('editVideoTitle').value = video.title;
            document.getElementById('editVideoDescription').value = video.description || '';
            document.getElementById('editModal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Handle edit
        async function handleEdit(event) {
            event.preventDefault();
            
            const videoId = document.getElementById('editVideoId').value;
            const title = document.getElementById('editVideoTitle').value;
            const description = document.getElementById('editVideoDescription').value;
            
            const result = await apiRequest(`/api/videos/${videoId}`, {
                method: 'PUT',
                body: JSON.stringify({ title, description })
            });
            
            if (result.success) {
                showMessage('Video updated successfully!', 'success');
                closeEditModal();
                loadVideos();
            } else {
                showMessage(result.error || 'Update failed', 'error');
            }
        }

        // Delete video
        async function deleteVideo(videoId) {
            if (!isAuthenticated()) {
                showMessage('Please login to delete videos', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this video?')) {
                return;
            }
            
            const result = await apiRequest(`/api/videos/${videoId}`, {
                method: 'DELETE'
            });
            
            if (result.success) {
                showMessage('Video deleted successfully!', 'success');
                loadVideos();
            } else {
                showMessage(result.error || 'Delete failed', 'error');
            }
        }

        // Start streaming
        function startStreaming(videoId) {
            if (!isAuthenticated()) {
                showMessage('Please login to watch videos', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }
            window.location.href = `streaming.html?videoId=${videoId}`;
        }

        // Load videos on page load
        loadVideos();
    </script>
</body>
</html>
